---
title: "节点"
weight: 2
description: 负载均衡集群中的节点用于监听负载均衡实例，并将客户端的请求根据监听和转发规则将其转发给后端服务器。
---

负载均衡集群中的节点用于监听负载均衡实例，并将客户端的请求根据监听和转发规则转发给后端服务器。

同一个集群下可以有多个转发节点，但同一时刻只有一个节点作为Master节点提供转发服务。属于一个集群的节点的VRRP路由ID必须相同。

节点生命周期管理：

1. 新建节点：设置节点的配置参数。
2. 部署节点：将节点的配置文件下发到指定机器，提供转发功能的机器可称为转发实例，当节点状态为Master时，表示集群中的节点可正常提供负载均衡转发服务。
3. 下线节点：当不需要节点提供服务时，可下线节点，将配置文件从转发实例上删除。
4. 删除节点：删除节点的配置文件信息等。

**入口**：在云管平台单击左上角![](../../../images/intro/nav.png)导航菜单，在弹出的左侧菜单栏中单击 **_"网络/负载均衡集群/节点"_** 菜单项，进入节点页面。

![](../../../images/network/lbagent1.png)


## 新建节点

该功能用于在指定集群下创建节点。

1. 单击列表上方 **_"新建"_** 按钮，弹出创建节点对话框。
2. 配置以下参数：
    - 名称：节点的名称。
    - 集群：节点所属的集群，若无合适集群，可单击输入框下的“新建”超链接创建集群。
    - 优先级：设置节点的优先级，数字越大优先级越大，优先级大的节点默认为master节点。
    - 抢占模式：设置是否启用抢占模式，当抢占模式开启后，若优先级高的backup节点遇到优先级低的master节点，backup节点将抢占成为master节点。
    - VRRP路由ID：设置节点的VRRP路由ID，同一集群下的节点的VRRP路由ID必须相同，不同集群下的节点的VRRP路由ID必须不同。
    - VRRP网口：节点广播通告用的网卡名称。
    - VRRP通告间隔：VRRP广播通告间隔，关系到故障时自动切换的灵敏度。

    **高级配置**：默认隐藏，可根据需求进行配置。

    - VRRP密码：设置VRRP通信的密码，主备节点的VRRP密码必须相同，为空则密码默认为YunionLB。 
    - 转发实例心跳超时时间：设置转发节点部署的虚拟机心跳超时时间，当超过超时时间的虚拟机未收到心跳时，状态将变为UNKNOWN，默认为3600秒，取值范围为600~3600。
    - 配置Telegraf参数：
        - InfluxDB地址：用于监控数据上传通道，一般InfluxDB部署在控制节点上，格式为[https://控制节点IP地址:30086](https://控制节点IP地址:30086)。
        - InfluxDB数据库名称：设置InfluxDB数据库的名称。
        - 监控数据采集间隔：设置telegraf采集监控数据的间隔，默认为5s，取值范围为1~600。
        - 配置模板：可根据需求自定义telegraf配置模板。
    - 配置HAProxy参数：
        - HAProxy线程数：设置HAProxy线程数，请根据实际情况设置。默认为1，取值范围为1~64。
        - 日志输出设置：设置日志的保存位置，支持保存到本地、远端服务器等，输入格式例如“/dev/log”、IP、IP:port。为空则表示不记录日志。
        - 记录HTTP日志：是否记录HTTP类型的日志。
        - 记录TCP日志：是否记录TCP类型的日志。
        - 记录Normal日志：是否记录正常日志。
        - 请求中最大http头数：设置请求中最大http头数量，默认为101，取值为1~32767。
        - 配置模板：可根据需求自定义HAProxy配置模板。
    - 配置Keepalived参数：
        - 配置模板：可根据需求自定义Keepalived配置模板。
3. 单击 **_"确定"_** 按钮，创建节点。

## 部署节点

节点创建完成后需要将其部署在虚拟机、宿主机或外部机器上才能正常使用，部署节点的过程即将的配置文件下发到绑定的虚拟机上面。

{{% alert title="注意" color="warning" %}}
当转发节点上有监听任意IP的某个端口的服务配置时，会造成在使用该转发节点的LB实例上配置对应协议端口的监听无法正常使用。
```
# 在转发节点上查看监听任意IP的端口情况
$ netstat -nlp |grep 0.0.0.0:
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      7120/sshd
```
通过查询可以发现转发节点上的sshd服务正在监听任意IP的TCP 22端口，如用户需要在LB实例上配置TCP 22端口的监听，则需要将转发节点的sshd配置文件，将"/etc/ssh/sshd_config"配置文件的`#ListenAddress 0.0.0.0`改为`ListenAddress <转发节点IP>` 。
{{% /alert %}}

1. 单击节点右侧操作列 **_"部署"_** 按钮，弹出部署对话框。
2. 配置以下参数：
    - 指定系统用户：需要使用系统管理员用户部署节点。设置项目为“system”、选择已知密码的系统用户名并输入对应密码。如不存在已知系统用户密码，可通过climc命令创建系统用户lbagent用户，并使用lbagent用户及密码部署。
{{% alert title="说明" %}}
```bash
# 创建lbagent系统用户
$ climc user-create lbagent --password xxx --system-account 
# 将lbagent用户以管理员的角色加入到system项目
$ climc project-add-user system lbagent admin
```
{{% /alert %}}
    - 部署类型：选择转发实例节点，请尽量选取相互独立的虚拟机、宿主机或外部机器。
        - 当选择虚拟机时，要求虚拟机与负载均衡集群处于同一可用区，且虚拟机与控制节点网络连通。
        - 当选择宿主机时，要求宿主机与负载均衡集群处于同一可用区，且宿主机与控制节点网络连通。
        - 当选择外部机器时，要求ansible server（一般为控制节点）能够访问到目标机器。且目标机器上存在cloudroot用户，cloudroot用户支持sudo免密登录，管理员使用公钥可以免密登录cloudroot等。 
{{% alert title="说明" %}}
```bash
# 获取管理员公钥
$ climc sshkeypair-show --admin
``` 
{{% /alert %}}
    - Yum源地址：Yum源地址，[https://yunioniso.oss-cn-beijing.aliyuncs.com/iso/{version}/rpms](https://yunioniso.oss-cn-beijing.aliyuncs.com/iso/{version}/rpms)，且建议不勾选Yum源TLS校验。
     
3. 单击 **_"确定"_** 按钮，弹出部署对话框，查看节点的部署情况。
4. 若部署未执行完成，可再次单击 **_"部署"_** 按钮，在弹出的部署对话框中的单击”任务正在执行中框中“提示框的”详情“超链接，查看节点的部署情况。
5. 节点部署完成后，将显示节点的主备以及心跳信息等。
  

## 下线节点

该功能用于下线节点，节点下线会将节点配置文件从部署主机上删除。

1. 单击节点右侧操作列 **_"下线"_** 按钮，弹出下线确认对话框。
2. 单击 **_"确定"_** 按钮，下线节点。

## 修改节点

该功能用于修改节点的配置信息。

1. 单击节点右侧操作列 **_"更多"_** 按钮，选择下拉菜单 **_"修改"_** 菜单项，进入修改节点页面。
2. 修改相关参数，单击 **_"确定"_** 按钮。

## 设置心跳超时时间

该功能用于修改转发实例的心跳超时时间。当转发实例超过超时时间未收到心跳时，节点状态将变为UNKNOWN。

1. 单击节点右侧操作列 **_"更多"_** 按钮，选择下拉菜单 **_"设置心跳超时时间"_** 菜单项，弹出设置心跳超时时间对话框。
2. 设置转发实例心跳超时时间，单击 **_"确定"_** 按钮，完成操作。


## 删除节点

只有节点下线后才可以删除节点。

1. 单击节点右侧操作列 **_"删除"_** 按钮，弹出删除确认对话框。
2. 勾选”确定已经实际操作下线“后，单击 **_"确定"_** 按钮，删除节点。

## 查看节点详情

该功能用于查看节点的配置信息等。

1. 在节点页面，单击节点名称项，进入节点详情页面。
2. 详情页面顶部菜单项支持对节点进行管理操作。
3. 查看以下信息。
    - 基础信息：查看节点的云上ID、ID、名称、状态、域、项目、集群、主备、上一次心跳、可用区、心跳超时时间、部署机器、创建时间、更新时间、备注。
    - 同步时间戳：表示数据库中负载均衡实例、监听、后端服务器组、后端服务器、转发策略、访问控制、证书等参数在某个特定时间之前已经存在、完整的、可验证的数据写入部署机器。
    - VRRP转发实例配置信息：包括通告间隔、网口、密码、抢占模式、优先级以及路由ID信息。
    - HAProxy配置信息：查看HAProxy配置信息，包括线程数、开启日志、开启HTTP日志、开启Normal日志、开启TCP日志、以及配置模板信息。
    - Telegraf（数据采集工具）配置信息：查看Telegraf配置信息，包括HAProxy上报间隔、数据库名称、地址、以及配置模板信息。
    - KeepAlived配置信息：查看KeepAlived配置模板信息。

### 查看部署详情

该功能用于查看节点的上次部署输出的日志信息，用于部署失败时通过输出日志进行排错等。部署详情仅在部署节点后才会出现。

1. 在节点详情页面，单击“部署详情”页签，进入部署详情页面。
2. 查看节点的部署详情以及输出日志等。
3. 支持重新执行或终止执行操作等。

### 查看操作日志

该功能用于查看节点相关操作的日志信息。

1. 在节点详情页面，单击“操作日志”页签，进入操作日志页面。
    - 加载更多日志：列表默认显示20条操作日志信息，如需查看更多操作日志，请单击 **_"加载更多"_** 按钮，获取更多日志信息。
    - 查看日志详情：单击操作日志右侧操作列 **_"查看"_** 按钮，查看日志的详情信息。支持复制详情内容。
    - 查看指定时间段的日志：如需查看某个时间段的操作日志，在列表右上方的开始日期和结束日期中设置具体的日期，查询指定时间段的日志信息。
    - 导出日志：目前仅支持导出本页显示的日志。单击右上角![](../../../images/system/download.png)图标，在弹出的导出数据对话框中，设置导出数据列，单击 **_"确定"_** 按钮，导出日志。
